# agent-env

> Universal secret injection for AI coding agents. One command. Every agent. Secrets stay out of your shell history.

## Overview

agent-env is a single bash script that loads secrets from `.env` (dotenv) or `.sops.env` (SOPS-encrypted) files and injects them into an AI agent's environment via `exec`. It works with any agent that runs as a CLI process.

## The Problem

AI coding agents need API keys -- `ANTHROPIC_API_KEY`, `OPENAI_API_KEY`, `GITHUB_TOKEN`, and more. Today you either:

- **Export them in `.bashrc`** -- clutters your shell, leaks to every process
- **Prefix every command** -- `ANTHROPIC_API_KEY=sk-... claude` in your history
- **Use direnv** -- not designed for secrets, no encryption support
- **Configure each agent separately** -- fragmented, different per tool

agent-env solves this with a single secrets file, automatic discovery, and optional encryption via SOPS.

## Install

```bash
# One-line install
curl -fsSL https://raw.githubusercontent.com/jordanburke/agent-env/main/install.sh | bash

# Or clone and install locally
git clone https://github.com/jordanburke/agent-env.git
cd agent-env && ./install.sh
```

Requires: bash 4+. Optional: sops + age for encrypted secrets.

## Quick Start

```bash
# 1. Create a secrets file
agent-env init

# 2. Add your keys
echo "ANTHROPIC_API_KEY=sk-ant-..." >> .env
echo "OPENAI_API_KEY=sk-..." >> .env

# 3. Run your agent
agent-env run claude
```

### With Encryption (SOPS + age)

```bash
# 1. Generate an age key (one-time)
age-keygen -o ~/.config/sops/age/keys.txt

# 2. Create an encrypted secrets file
agent-env init --sops

# 3. Edit secrets (opens in $EDITOR via sops)
agent-env edit

# 4. Run your agent
agent-env run claude
```

## Supported Agents

| Agent | Command |
|-------|---------|
| Claude Code | `agent-env run claude` |
| Codex | `agent-env run codex` |
| Aider | `agent-env run aider` |
| Goose | `agent-env run goose` |
| Cline | `agent-env run cline` |
| Continue | `agent-env run continue` |
| Cursor (CLI) | `agent-env run cursor` |
| Windsurf (CLI) | `agent-env run windsurf` |
| Any CLI tool | `agent-env run <command>` |

## CLI Reference

```
agent-env <command> [options]

COMMANDS
  run <agent> [args...]   Inject secrets and launch an AI agent
  init [--sops]           Create a new secrets file
  edit                    Edit secrets (sops edit or $EDITOR)
  view                    View decrypted secrets
  check                   Verify setup (files, tools, keys)
  upgrade                 Self-update from git
  uninstall               Remove agent-env
  version                 Print version
  help                    Show usage

RUN OPTIONS
  -v, --verbose           Show discovery and loading steps
  --env FILE              Use a specific secrets file
  --secrets FILE          Alias for --env
  --sops                  Force SOPS mode
  --dotenv                Force dotenv mode
```

## Architecture

```
agent-env run claude
    |
    v
  Discover secrets file
  (walk up from PWD to git root, then global fallbacks)
    |
    v
  Auto-detect format
  (grep "^sops:" -> SOPS, else dotenv)
    |
    v
  Load secrets into environment
    SOPS:   sops exec-env <file> '<command>'
    dotenv: set -a; source <file>; set +a
    |
    v
  exec <agent> "$@"
  (process replacement -- no parent lingers)
```

## File Discovery

agent-env searches for secrets files in this order:

1. `.sops.env` or `.env` in the current directory
2. Walk up parent directories to the git root
3. `$XDG_CONFIG_HOME/agent-env/` (default: `~/.config/agent-env/`)
4. Home directory (`~/.sops.env` or `~/.env`)

SOPS files (`.sops.env`) always take priority over dotenv (`.env`) when both exist in the same directory.

### Override

Use `--env FILE` to skip discovery and use a specific file:

```bash
agent-env run --env ~/work/.secrets claude
```

## Layered Secrets

agent-env loads secrets in two layers (project overrides global):

1. **Global**: `~/.config/agent-env/.sops.env` -- cross-project keys (loaded for every project)
2. **Project**: `<repo>/.sops.env` -- project-specific keys (loaded only if present)

Project values override global values for the same key. This means shared keys like `ANTHROPIC_API_KEY` or `GITHUB_TOKEN` only need to exist in the global file. Project-specific keys (like database URLs) go in the project's `.sops.env`.

Use `agent-env run --no-global claude` to skip global loading.

## SOPS vs Dotenv

| Feature | Dotenv (`.env`) | SOPS (`.sops.env`) |
|---------|-----------------|---------------------|
| Setup | Zero config | Requires sops + age |
| Security | Plaintext on disk | Encrypted at rest |
| Git-safe | Must be .gitignored | Safe to commit |
| Sharing | Manual copy | Encrypted, sharable |
| Editing | Any editor | `agent-env edit` / `sops` |
| Best for | Solo dev, local | Teams, CI, production |

## MCP Servers

agent-env works with MCP servers too -- just wrap the MCP command:

```json
{
  "mcpServers": {
    "my-server": {
      "command": "agent-env",
      "args": ["run", "--env", "/path/to/.env", "node", "server.js"]
    }
  }
}
```

## Security Model

- Secrets are loaded into the process environment only -- never written to disk by agent-env
- Process replacement via `exec` -- the agent-env process ceases to exist after launch
- SOPS provides encryption-at-rest with age or GPG backends
- No secrets appear in command-line arguments (environment variables only)
- `.env` files are excluded from git via `.gitignore` (enforced by `init`)

## New Machine Setup

Setting up agent-env on a new machine requires the Age private key (for SOPS decryption) and the global secrets file.

### Step 1: Install prerequisites

```bash
# macOS
brew install sops age

# Linux
# See https://github.com/getsops/sops and https://github.com/FiloSottile/age
```

### Step 2: Transfer your Age key

The Age private key at `~/.config/sops/age/keys.txt` is the root of trust. Transfer it via a secure out-of-band method:

**Bitwarden CLI** (recommended):
```bash
# On existing machine -- store the key
cat ~/.config/sops/age/keys.txt | bw create item "age-key"

# On new machine -- retrieve the key
mkdir -p ~/.config/sops/age
bw get notes "age-key" > ~/.config/sops/age/keys.txt
chmod 600 ~/.config/sops/age/keys.txt
```

**SCP** (between machines on same network):
```bash
scp user@existing-machine:~/.config/sops/age/keys.txt ~/.config/sops/age/keys.txt
chmod 600 ~/.config/sops/age/keys.txt
```

**1Password / other password manager**: Store as a Secure Note, copy to `~/.config/sops/age/keys.txt` on new machine.

### Step 3: Install agent-env

```bash
curl -fsSL https://raw.githubusercontent.com/jordanburke/agent-env/main/install.sh | bash
```

### Step 4: Sync global secrets

If you manage dotfiles with Chezmoi:
```bash
# On existing machine (one-time)
chezmoi add ~/.config/agent-env/.sops.env

# On new machine
chezmoi apply
```

Or copy manually:
```bash
scp user@existing-machine:~/.config/agent-env/.sops.env ~/.config/agent-env/.sops.env
```

Since `.sops.env` is SOPS-encrypted, it's safe to store in your dotfiles repo.

### Step 5: Verify

```bash
agent-env check        # verify setup
agent-env view         # confirm secrets decrypt
```

### Per-machine keys (optional)

For better security, generate a unique Age key per machine and add all public keys to your `.sops.yaml` files:

```bash
# Generate new key on new machine
age-keygen -o ~/.config/sops/age/keys.txt

# Add the public key to .sops.yaml in each repo
# Then re-encrypt all files:
sops updatekeys .sops.env
```

This lets you revoke a single machine without affecting others.

## Uninstall

```bash
agent-env uninstall
```

Your secrets files and encryption keys are never removed.

## Related Projects

- [sops](https://github.com/getsops/sops) -- Secrets OPerationS, encrypts files with age/GPG/cloud KMS
- [age](https://github.com/FiloSottile/age) -- Simple, modern encryption tool
- [direnv](https://direnv.net/) -- Per-directory environment variables (not secret-focused)
- [dotenvx](https://dotenvx.com/) -- Extended dotenv with encryption
- [1Password CLI](https://developer.1password.com/docs/cli/) -- Secret injection from 1Password vaults

## License

MIT - Jordan Burke
